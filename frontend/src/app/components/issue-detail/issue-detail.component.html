<div class="detail-container">
    <div *ngIf="loading" class="loading-state">
        Caricamento in corso...
    </div>

    <div *ngIf="error" class="error-state">
        {{ error }}
        <button routerLink="/issue-board" class="btn-back">Torna alla Dashboard</button>
    </div>

    <div *ngIf="issue" class="issue-content">
        <div class="header-actions">
            <button routerLink="/issue-board" class="btn-back">← Torna alla Board</button>
            <div class="actions" *ngIf="isAdmin">
                <button class="btn-edit" [routerLink]="['/edit', issue.id]">Modifica</button>
            </div>
        </div>

        <div class="issue-header">
            <span class="issue-id">#{{ issue.id }}</span>
            <h1>{{ issue.title }}</h1>
        </div>

        <div class="meta-badges">
            <span class="badge" [ngClass]="getStatusClass(issue.status)">{{ issue.status }}</span>
            <span class="badge" [ngClass]="getPriorityClass(issue.priority)">{{ issue.priority }}</span>
            <span class="type-badge">{{ issue.type }}</span>
        </div>

        <div class="issue-body">
            <div class="main-info">
                <h3>Descrizione</h3>
                <p class="description">{{ issue.description }}</p>

                <div *ngIf="issue.imageUrl" class="attachment-section">
                    <h3>Allegati</h3>
                    <img [src]="issue.imageUrl" alt="Allegato Issue" class="issue-image">
                </div>
            </div>

            <div class="side-info">
                <div class="info-group">
                    <label>Assegnato a</label>
                    <span *ngIf="issue.assigneeId">{{ issue.assigneeFullName }}</span>
                    <span *ngIf="!issue.assigneeId">Non assegnato</span>
                </div>
                <div class="info-group">
                    <label>Segnalato da</label>
                    <span *ngIf="issue.reporterId">{{ issue.reporterFullName }}</span>
                    <span *ngIf="!issue.reporterId">Anonimo</span>
                </div>
                <div class="info-group">
                    <label>Scadenza</label>
                    <span [class.overdue]="false">{{ issue.deadline ? (issue.deadline | date:'medium') : 'Nessuna
                        scadenza' }}</span>
                </div>
                <div class="info-group">
                    <label>Creato il</label>
                    <span>{{ issue.dateAdded | date:'medium' }}</span>
                </div>
            </div>
        </div>

        <!-- Sezione Modifica (Req 4, 6, 18) - visibile solo ad ADMIN o all'utente assegnatario -->
        <div class="edit-section" *ngIf="isAdmin || issue.assigneeId === currentUserId">
            <h3>Modifica Issue</h3>

            <!-- Cambio Stato (Req 6) - visibile a tutti -->
            <div class="form-group">
                <label>Stato</label>
                <select #statusEditRef>
                    <option value="TODO" [selected]="issue.status === 'TODO'">TODO</option>
                    <option value="IN_PROGRESS" [selected]="issue.status === 'IN_PROGRESS'">IN PROGRESS</option>
                    <option value="DONE" [selected]="issue.status === 'DONE'">DONE</option>
                    <option value="DUPLICATE" [selected]="issue.status === 'DUPLICATE'">DUPLICATE</option>
                </select>
            </div>

            <!-- Assegnazione Utente (Req 4) - solo ADMIN (nascosto con [hidden] per mantenere il ref nel DOM) -->
            <div class="form-group" [hidden]="!isAdmin">
                <label>Assegna a</label>
                <select #assigneeRef>
                    <option value="">Nessuno</option>
                    <option *ngFor="let u of usersList" [value]="u.id" [selected]="issue.assigneeId === u.id">
                        {{ u.name }} {{ u.surname }}
                    </option>
                </select>
            </div>

            <!-- Scadenza (Req 18) - solo ADMIN (nascosto con [hidden] per mantenere il ref nel DOM) -->
            <div class="form-group" [hidden]="!isAdmin">
                <label>Scadenza</label>
                <input type="datetime-local" #deadlineRef
                    [value]="issue.deadline ? (issue.deadline | date:'yyyy-MM-ddTHH:mm') : ''" />
            </div>

            <!-- Salva: admin passa tutti i campi, developer solo lo stato -->
            <ng-container *ngIf="isAdmin; else devSave">
                <button class="btn-save"
                    (click)="saveChanges(statusEditRef.value, assigneeRef.value, deadlineRef.value)">
                    Salva Modifiche
                </button>
            </ng-container>
            <ng-template #devSave>
                <button class="btn-save" (click)="saveChanges(statusEditRef.value, '', '')">
                    Aggiorna Stato
                </button>
            </ng-template>
            <span *ngIf="saveSuccess" style="color: green; margin-left: 12px;">✓ Salvato!</span>
        </div>


    </div>

</div>